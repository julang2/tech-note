
与查询流程不一样的是，更新流程还涉及两个重要的日志模块：`redo log（重做日志）`和`binlog（归档日志）`。

# redo log

`redo log`是InnoDB引擎特有的日志。

如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后再更新，整个过程IO成本、查找成本都很高。MySQL采用WAL（Write-Ahead Logging）技术解决这类问题，关键点就是先写日志，再写磁盘。

具体来说，当有一条记录需要更新的时候，InnoDB引擎就会先把记录写到`redo log`里（是否会写进磁盘？），并更新内存（省略了查找功能？），这个时候更新就算完成了。同时，InnoDB引擎会在适当的时候，将这个操作记录更新到磁盘里面，而这个更新往往是在系统比较空闲的时候做。

InnoDB的`redo log`是固定大小的，比如可以配置为一组4个文件，每个文件的大小是1GB，那么总共可以记录4GB的操作。从头开始写，写到末尾就又回到开头循环写。`write pos`是当前记录的位置，一边写一遍后移，写到第3号文件的末尾就回到0号文件开头。 `checkpoint`是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件（磁盘中）。`write pos`和`checkpoint`之间是可使用的空间，可以用来记录新的操作。如果`write pos`追上`checkpoint`，就不能执行新的更新，得停下来先擦掉一些记录，把`checkpoint`推进一下。

有了`redo log`，InnoDB就可以保证即使数据库发生异常重启，**之前提交的记录**都不会丢失，这个能力称为`crash-safe`。

`innodb_flush_log_at_trx_commit`这个参数设置成1的时候，表示每次事务的`redo log`都直接持久化到磁盘。这个参数我建议你设置成1，这样可以保证MySQL异常重启之后数据不丢失。

# binlog

`binlog（归档日志）`是MySQL的Server层的日志。

`binlog`和`redo log`区别：

- `redo log`是InnoDB引擎特有的；`binlog`是MySQL的Server层实现的，所有引擎都可以使用。

- `redo log`是物理日志，记录的是“在某个数据页上做了什么修改”；`binlog`是逻辑日志，记录的是这个语句的原始逻辑，比如“给ID=2这一行的c字段加1 ”。

- `redo log`是循环写的，空间固定会用完；`binlog`是可以追加写入的。“追加写”是指`binlog`文件写到一定大小后会切换到下一个，并不会覆盖以前的日志。

`sync_binlog`这个参数设置成1的时候，表示每次事务的binlog都持久化到磁盘。这个参数我也建议你设置成1，这样可以保证MySQL异常重启之后binlog不丢失。

执行器和InnoDB引擎在执行update语句（update T set c=c+1 where ID=2;）时的内部流程：

- 执行器先找引擎取ID=2这一行。ID是主键，引擎直接用树搜索找到这一行。如果ID=2这一行所在的数据页本来就在内存中，就直接返回给执行器；否则，需要先从磁盘读入内存，然后再返回。

- 执行器拿到引擎给的行数据，把这个值加上1，比如原来是N，现在就是N+1，得到新的一行数据，再调用引擎接口写入这行新数据。

- 引擎将这行新数据**更新到内存（InnoDB buffer pool）**中，同时将这个**更新操作记录到`redo log`里面**，此时`redo log`处于`prepare`状态。然后告知执行器执行完成了，随时可以提交事务。

- 执行器生成这个操作的`binlog`，并把`binlog`写入磁盘（`sync_binlog`=1）。

- 执行器调用引擎的提交事务接口，引擎把刚刚写入的`redo log`改成`commit`提交状态，更新完成。`innodb_flush_log_at_trx_commit`=1时，把`redo log`写入磁盘。

`redo log`的写入拆成了两个步骤：`prepare`和`commit`，这就是"两阶段提交"。`redo log`和`binlog`都可以用于表示事务的提交状态，而两阶段提交就是让这两个状态保持逻辑上的一致。两阶段提交是跨系统维持数据逻辑一致性时常用的一个方案。

DBA会定期做数据库的整库备份。当要恢复到指定时间的数据库时的流程：


- 首先，找到最近的一次全量备份。

- 然后，从备份的时间点开始，将备份的`binlog`依次取出来，重放到指定时刻。

不只是误操作后需要用这个过程来恢复数据。当你要扩容的时候，也就是需要再多搭建一些备库来增加系统的读能力的时候，，现在常见的做法也是用全量备份加上应用binlog来实现的，同时，`redo log`的两阶段提交可以保证主从数据库的数据一致。
